# SecurePay Integration Guide for Craft Commerce

This guide provides comprehensive instructions for integrating the SecurePay payment gateway with Craft Commerce, following the [official SecurePay API documentation](https://auspost.com.au/payments/docs/securepay/?javascript#integrating-with-securepay).

**Plugin**: `brightlabs/craft-securepay` v1.1.0  
**Developer**: [Brightlabs](https://brightlabs.com.au/)  
**API**: SecurePay API v2 with OAuth 2.0

## Overview

This plugin implements the SecurePay API v2 using the **JavaScript SDK Integration** for enhanced security and PCI compliance. It tokenizes card data on the client-side, ensuring that no sensitive payment information ever touches your server.

## Integration Architecture

```
Frontend (JavaScript SDK) ←→ SecurePay Servers (Tokenization)
         ↓ (Token)
   Craft Commerce ←→ SecurePay API v2 (REST API Payment)
         ↓
   Backend Processing (Order Completion)
```

## 1. JavaScript SDK Integration

### Overview
The JavaScript SDK integration follows the SecurePay official documentation for secure client-side tokenization. The plugin handles the entire process automatically.

### Features
- **PCI Compliance**: Card data is tokenized and never touches your server
- **Enhanced Security**: Client-side tokenization
- **Real-time Validation**: The SDK provides instant card validation in the browser
- **Customizable UI**: The payment form can be styled from the gateway settings in the Craft CP

### Implementation

#### 1.1 SDK Loading
The plugin automatically loads the correct SDK script (sandbox or live) based on your gateway settings.

```javascript
// Sandbox SDK URL
<script src="https://payments-stest.npe.auspost.zone/v2/ui/securepay.min.js"></script>

// Live SDK URL
<script src="https://payments.auspost.net.au/v2/ui/securepay.min.js"></script>
```

#### 1.2 Configuration
The plugin handles the configuration of the JavaScript SDK automatically using the settings you provide in the Craft Commerce gateway settings.

```javascript
// This configuration is handled by the plugin in the background
const securePayConfig = {
    clientId: 'your-client-id-from-settings',
    merchantCode: 'your-merchant-code-from-settings',
    baseUrl: 'https://payments-stest.npe.auspost.zone', // Set by sandbox mode toggle
    style: {
        // All styling options are configured in gateway settings
        backgroundColor: '#ffffff',
        labelFontColor: '#000080',
        // ... and many more
    }
};
```

#### 1.3 Payment Flow
1. Customer enters payment details into the secure form rendered by the plugin.
2. The JavaScript SDK tokenizes the card data on the client-side upon form submission.
3. The plugin's JavaScript submits the generated token to Craft Commerce.
4. The gateway processes the payment with the SecurePay API using the token.
5. SecurePay returns a response (success or error).
6. Commerce completes the order or displays an error message.

#### 1.4 Craft Commerce Integration
You only need to output the payment form in your checkout template. The plugin handles the rest.

```twig
{# In your checkout template: #}

{% set cart = craft.commerce.carts.cart %}
{% set gateway = cart.gateway %}

<form method="post">
    {{ csrfInput() }}
    {{ actionInput('commerce/payments/pay') }}
    {{ hiddenInput('gatewayId', gateway.id) }}
    
    {# The gateway renders the complete payment form with JS #}
    {{ gateway.getPaymentFormHtml()|raw }}
    
    <button type="submit">Complete Payment</button>
</form>
```

## 2. REST API Integration

### Authentication
The plugin uses the OAuth 2.0 Client Credentials flow and automatically caches the access token for 24 hours to improve performance.

```php
// Authentication is handled automatically by the plugin
POST https://welcome.api2.sandbox.auspost.com.au/oauth/token
Authorization: Basic base64(clientId:clientSecret)
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials&audience=https://api.payments.auspost.com.au
```

### Payment Creation
The plugin creates a payment on the backend using the token generated by the JavaScript SDK. **Raw card data is never sent from the server.**

```php
// This request is made by the plugin on the server-side
POST https://payments-stest.npe.auspost.zone/v2/payments
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "merchantCode": "your-merchant-code",
    "token": "tok_123abc_generated_by_js_sdk",
    "ip": "123.123.123.123",
    "amount": 2500, // $25.00 in cents
    "currency": "AUD",
    "orderId": "12345"
}
```


## 7. Testing

### Test Environment
- **Sandbox URL**: `https://payments-stest.npe.auspost.zone`
- **OAuth URL**: `https://welcome.api2.sandbox.auspost.com.au/oauth/token`

### Test Cards

#### Standard Test Cards
- **Visa**: `4111111111111111`
- **Mastercard**: `5555555555554444`
- **Amex**: `378282246310005`

#### Error Testing Cards
- **Declined**: `4000000000000002`
- **Insufficient Funds**: `4000000000009995`
- **Expired Card**: `4000000000000069`

**Note**: 3D Secure and other advanced features are not yet implemented in this version of the plugin.

### Test Data
- **Expiry**: Any future date (e.g., `12/2025`)
- **CVV**: Any 3-4 digit number (e.g., `123`)
- **Name**: Any name

## 8. Production Deployment

### Checklist
1. ✅ Obtain live API credentials from SecurePay.
2. ✅ Create a new SecurePay gateway configuration in Craft Commerce with the live credentials.
3. ✅ Disable "Sandbox Mode" in the gateway settings. The plugin will automatically use production URLs.
4. ✅ Ensure your website has a valid SSL/TLS certificate (HTTPS is required).
5. ✅ Test the live gateway with small transactions.
6. ✅ Monitor transaction logs in the Craft Commerce control panel.

### Production URLs
The plugin automatically switches to these URLs when "Sandbox Mode" is disabled:
- **API Base URL**: `https://payments.auspost.net.au`
- **OAuth URL**: `https://welcome.api2.auspost.com.au/oauth/token`

## 9. Monitoring and Logging

### Transaction Monitoring
- Monitor success/failure rates in the Craft Commerce control panel under `Commerce > Transactions`.
- Review transaction details for any error messages returned by SecurePay.

### Logging Best Practices
The plugin logs important events and errors. You can find these logs in your `storage/logs` directory.
```php
// Example of an info log from the plugin
Craft::info('CreatePaymentResponse Response: {"status":"paid", ...}', __METHOD__);

// Example of an error log from the plugin
Craft::error('SecurePay payment error: Invalid token', __METHOD__);
```

## 10. Support and Resources

### Official Documentation
- [SecurePay API Documentation](https://auspost.com.au/payments/docs/securepay/)
- [JavaScript SDK Reference](https://auspost.com.au/payments/docs/securepay/?javascript#javascript-sdk)

### Support Channels
- For issues with the plugin itself, please open an issue on the [GitHub repository](https://github.com/brightlabs/craft-securepay/issues).
- For issues with your SecurePay account or the API service, contact SecurePay support.

### Troubleshooting

#### Common Issues
1. **Authentication Failed**
   - Double-check that your Merchant Code, Client ID, and Client Secret are correct in the gateway settings.
   - Ensure you are using the correct environment (Sandbox/Live) that matches your credentials.
   - Check for firewall or network issues blocking requests to SecurePay's API.

2. **Payment Form Not Appearing**
   - Ensure the gateway is enabled and available for the current cart/order.
   - Check your browser's developer console for any JavaScript errors.
   - Verify that your Twig template is correctly calling `gateway.getPaymentFormHtml()`.

3. **Transactions Failing**
   - Check the transaction details in Craft Commerce for specific error messages from SecurePay.
   - Ensure the currency being used is supported by your SecurePay account (currently hardcoded to AUD).
   - Test with valid test card numbers to rule out card-specific issues.

## 11. Security Best Practices

### PCI Compliance
- The plugin is designed for PCI compliance by using the SecurePay JavaScript SDK.
- **Never** modify the plugin to send raw card data from your server.
- Ensure your server environment follows security best practices (e.g., file permissions, access controls).

### API Security
- Protect your API credentials. Do not hardcode them in your templates or commit them to version control.
- Use Craft's environment variables (`.env` file) to store sensitive credentials and reference them in your gateway settings.

### Client-Side Security
- Always serve your checkout pages over HTTPS.
- Consider implementing Content Security Policy (CSP) headers to restrict script sources.

---

This integration guide follows the official SecurePay documentation patterns and provides a complete implementation reference for Craft Commerce developers. 
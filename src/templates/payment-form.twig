{# @var gateway craft\securepay\gateways\Gateway #}
{# @var paymentForm craft\securepay\models\SecurePayPaymentForm #}
{% do view.registerCss("
#securepay-card-component iframe{
    width: 100%;
}
") %}
{% import "_includes/forms" as forms %}

<div class="securepay-payment-form" id="securepay-payment-form">
    {% if gateway.threeDSecure %}
        <div class="field">
            <div class="heading">
                <label>{{ 'üîí Secure Payment'|t('commerce') }}</label>
            </div>
            <div class="instructions">
                <p>{{ 'This payment will be processed with 3D Secure 2.0 authentication for enhanced security.'|t('commerce') }}</p>
            </div>
        </div>
    {% endif %}

    {% if gateway.useJavaScriptSDK %}
        {# JavaScript SDK Integration - Following Official Documentation #}
        <div class="field">
            <div class="heading">
                <label>{{ 'Payment Details'|t('commerce') }}</label>
            </div>
            <div class="instructions">
                <p>{{ 'Powered by SecurePay for secure payment processing'|t('commerce') }}</p>
            </div>
        </div>

        {# SecurePay UI Component Container #}
        <div id="securepay-card-component" class="securepay-card-component">
            {# This will be populated by the SecurePay JavaScript SDK #}
        </div>

        {# Hidden fields for Craft Commerce form submission #}
        <input type="hidden" name="paymentToken" id="payment-token" value="">
        <input type="hidden" name="paymentMethod" id="payment-method" value="securepay-js">
        <input type="hidden" name="deviceFingerprint" id="device-fingerprint" value="">
        <button class="button submit" onclick="window.mySecurePayUI.tokenise();return false;">Submit</button>
        <button class="button reset" onclick="window.mySecurePayUI.reset();return false;">Reset</button>
    {% else %}
        {# Traditional Credit Card Form for Direct API Integration #}
        <div class="field">
            <div class="heading">
                <label>{{ 'Credit Card Details'|t('commerce') }}</label>
            </div>
        </div>

        {{ forms.textField({
            label: 'Card Number'|t('commerce'),
            placeholder: '1234 5678 9012 3456',
            autocomplete: 'cc-number',
            id: 'number',
            name: 'number',
            maxlength: 19,
            class: 'cc-number',
            required: true,
            value: paymentForm.number ?? '',
        }) }}

        <div class="flex -mx-2">
            <div class="w-1/2 px-2">
                {{ forms.selectField({
                    label: 'Expiry Month'|t('commerce'),
                    id: 'month',
                    name: 'month',
                    value: paymentForm.month ?? '',
                    options: {
                        '01': '01 - January',
                        '02': '02 - February',
                        '03': '03 - March',
                        '04': '04 - April',
                        '05': '05 - May',
                        '06': '06 - June',
                        '07': '07 - July',
                        '08': '08 - August',
                        '09': '09 - September',
                        '10': '10 - October',
                        '11': '11 - November',
                        '12': '12 - December',
                    },
                    required: true,
                }) }}
            </div>
            <div class="w-1/2 px-2">
                {% set currentYear = date().format('Y') %}
                {% set years = {} %}
                {% for i in 0..10 %}
                    {% set year = currentYear + i %}
                    {% set years = years|merge({(year): year}) %}
                {% endfor %}
                {{ forms.selectField({
                    label: 'Expiry Year'|t('commerce'),
                    id: 'year',
                    name: 'year',
                    value: paymentForm.year ?? '',
                    options: years,
                    required: true,
                }) }}
            </div>
        </div>

        <div class="flex -mx-2">
            <div class="w-1/2 px-2">
                {{ forms.textField({
                    label: 'CVV'|t('commerce'),
                    placeholder: '123',
                    autocomplete: 'cc-csc',
                    id: 'cvv',
                    name: 'cvv',
                    maxlength: 4,
                    class: 'cc-csc',
                    required: true,
                    value: paymentForm.cvv ?? '',
                }) }}
            </div>
            <div class="w-1/2 px-2">
                {# Empty div for layout balance #}
            </div>
        </div>

        <div class="flex -mx-2">
            <div class="w-1/2 px-2">
                {{ forms.textField({
                    label: 'First Name'|t('commerce'),
                    autocomplete: 'cc-given-name',
                    id: 'firstName',
                    name: 'firstName',
                    required: true,
                    value: paymentForm.firstName ?? '',
                }) }}
            </div>
            <div class="w-1/2 px-2">
                {{ forms.textField({
                    label: 'Last Name'|t('commerce'),
                    autocomplete: 'cc-family-name',
                    id: 'lastName',
                    name: 'lastName',
                    required: true,
                    value: paymentForm.lastName ?? '',
                }) }}
            </div>
        </div>
    {% endif %}

    {% if gateway.applePay %}
        <div class="field apple-pay-container">
            <div class="heading">
                <label>{{ 'Apple Pay'|t('commerce') }}</label>
            </div>
            <div class="instructions">
                <p>{{ 'Pay quickly and securely with Apple Pay'|t('commerce') }}</p>
            </div>
            <div id="apple-pay-button" class="apple-pay-button" style="display: none;">
                {# Apple Pay button will be shown by JavaScript if available #}
            </div>
        </div>
    {% endif %}

    {% if gateway.fraudDetection %}
        <div class="field">
            <div class="heading">
                <label>{{ 'üõ°Ô∏è Fraud Protection'|t('commerce') }}</label>
            </div>
            <div class="instructions">
                <p>{{ 'This payment will be screened for fraud detection using {provider}.'|t('commerce', { provider: gateway.fraudProvider|title }) }}</p>
            </div>
        </div>
    {% endif %}

    {% if gateway.dynamicCurrencyConversion %}
        <div class="field dcc-container" id="dcc-container" style="display: none;">
            <div class="heading">
                <label>{{ 'Currency Conversion'|t('commerce') }}</label>
            </div>
            <div class="instructions">
                <p>{{ 'You can choose to pay in your local currency if available.'|t('commerce') }}</p>
            </div>
            <div id="dcc-options">
                {# DCC options will be populated by JavaScript #}
            </div>
        </div>
    {% endif %}

    {# Payment processing status #}
    <div id="payment-processing" class="payment-processing" style="display: none;">
        <div class="spinner"></div>
        <p>{{ 'Processing your payment...'|t('commerce') }}</p>
    </div>
</div>

{% if gateway.useJavaScriptSDK %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof window.securePayInstance !== 'undefined') {
        alert(1);
        initializeSecurePayForm();
    } else {
        // Wait for SecurePay SDK to load
        window.addEventListener('securepay-loaded', initializeSecurePayForm);
    }
});

function initializeSecurePayForm() {
    const securePayConfig = {
        containerId: 'securepay-card-component',
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                fontFamily: '"Helvetica Neue", Helvetica, Arial, sans-serif',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
            invalid: {
                color: '#9e2146',
            },
            complete: {
                color: '#13ce66',
            },
        },
        {% if gateway.threeDSecure %}
        threeDSecure: {
            enabled: true,
            challengeIndicator: '01'
        },
        {% endif %}
        {% if gateway.fraudDetection %}
        fraud: {
            enabled: true,
            provider: '{{ gateway.fraudProvider }}',
            onDeviceDataCollected: function(deviceData) {
                document.getElementById('device-fingerprint').value = deviceData;
            }
        },
        {% endif %}
        {% if gateway.dynamicCurrencyConversion %}
        dcc: {
            enabled: true,
            onQuoteReceived: function(quote) {
                displayDCCOptions(quote);
            }
        },
        {% endif %}
    };

    // Initialize SecurePay card component
    window.securePayCard = window.securePayInstance.createElement('card', securePayConfig);
    window.securePayCard.mount('#securepay-card-component');

    // Handle card validation events
    window.securePayCard.on('change', function(event) {
        if (event.error) {
            showError(event.error.message);
        } else {
            clearError();
        }
    });

    // Handle form submission - Following Commerce patterns
    const paymentForm = document.querySelector('#securepay-payment-form').closest('form');
    if (paymentForm) {
        paymentForm.addEventListener('submit', handleFormSubmit);
    }

    {% if gateway.applePay %}
    // Initialize Apple Pay if available
    if (window.securePayInstance.canMakeApplePayPayments()) {
        initializeApplePay();
    }
    {% endif %}
}

function handleFormSubmit(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitButton = form.querySelector('button[type="submit"], input[type="submit"]');
    
    // Show processing state
    showProcessing(true);
    
    // Disable submit button
    if (submitButton) {
        submitButton.disabled = true;
        const originalText = submitButton.textContent || submitButton.value;
        submitButton.textContent = '{{ "Processing..."|t("commerce") }}';
        submitButton.dataset.originalText = originalText;
    }

    // Create payment token using SecurePay SDK
    window.securePayInstance.createToken(window.securePayCard).then(function(result) {
        if (result.error) {
            // Show error to customer
            showError(result.error.message);
            
            // Re-enable submit button
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = submitButton.dataset.originalText || '{{ "Pay Now"|t("commerce") }}';
            }
            
            showProcessing(false);
        } else {
            // Submit the form with the token - Following Commerce patterns
            document.getElementById('payment-token').value = result.token.id;
            
            // Add any DCC selection
            const dccSelection = document.querySelector('input[name="dcc-selection"]:checked');
            if (dccSelection) {
                const hiddenDccInput = document.createElement('input');
                hiddenDccInput.type = 'hidden';
                hiddenDccInput.name = 'dcc-selection';
                hiddenDccInput.value = dccSelection.value;
                form.appendChild(hiddenDccInput);
            }
            
            // Submit to Commerce payment processing
            form.submit();
        }
    }).catch(function(error) {
        showError('{{ "Payment processing failed. Please try again."|t("commerce") }}');
        
        // Re-enable submit button
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = submitButton.dataset.originalText || '{{ "Pay Now"|t("commerce") }}';
        }
        
        showProcessing(false);
    });
}

{% if gateway.applePay %}
function initializeApplePay() {
    const applePayButton = document.getElementById('apple-pay-button');
    if (applePayButton) {
        applePayButton.style.display = 'block';
        applePayButton.addEventListener('click', function() {
            const paymentRequest = {
                countryCode: '{{ craft.commerce.carts.cart.billingAddress.countryCode|default("AU") }}',
                currencyCode: '{{ craft.commerce.carts.cart.currency }}',
                total: {
                    label: '{{ siteName }}',
                    amount: '{{ craft.commerce.carts.cart.totalPrice }}'
                }
            };
            
            window.securePayInstance.processApplePayPayment(paymentRequest).then(function(result) {
                if (result.token) {
                    document.getElementById('payment-token').value = result.token.id;
                    document.getElementById('payment-method').value = 'apple-pay';
                    document.querySelector('#securepay-payment-form').closest('form').submit();
                }
            }).catch(function(error) {
                showError('{{ "Apple Pay payment failed. Please try again."|t("commerce") }}');
            });
        });
    }
}
{% endif %}

{% if gateway.dynamicCurrencyConversion %}
function displayDCCOptions(quote) {
    const dccContainer = document.getElementById('dcc-container');
    const dccOptions = document.getElementById('dcc-options');
    
    if (quote && quote.rates && quote.rates.length > 0) {
        dccContainer.style.display = 'block';
        
        let optionsHtml = '<div class="dcc-options">';
        
        // Add original currency option
        optionsHtml += `
            <label class="dcc-option">
                <input type="radio" name="dcc-selection" value="original" checked>
                Pay {{ quote.originalAmount }} {{ quote.originalCurrency }} (Original Currency)
            </label>
        `;
        
        // Add converted currency options
        quote.rates.forEach(function(rate) {
            optionsHtml += `
                <label class="dcc-option">
                    <input type="radio" name="dcc-selection" value="${rate.currency}">
                    Pay ${rate.convertedAmount} ${rate.currency} 
                    <small>(Rate: ${rate.exchangeRate}, Fee: ${rate.fee || 0})</small>
                </label>
            `;
        });
        optionsHtml += '</div>';
        
        dccOptions.innerHTML = optionsHtml;
    }
}
{% endif %}

function showError(message) {
    clearError();
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'securepay-error alert alert-error';
    errorDiv.textContent = message;
    
    const form = document.getElementById('securepay-payment-form');
    form.insertBefore(errorDiv, form.firstChild);
    
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function clearError() {
    const errorDiv = document.querySelector('.securepay-error');
    if (errorDiv) {
        errorDiv.remove();
    }
}

function showProcessing(show) {
    const processingDiv = document.getElementById('payment-processing');
    if (processingDiv) {
        processingDiv.style.display = show ? 'block' : 'none';
    }
}
</script>
{% endif %}

<style>
.securepay-payment-form .flex {
    display: flex;
}
.securepay-payment-form .w-1\/2 {
    width: 50%;
}
.securepay-payment-form .-mx-2 {
    margin-left: -0.5rem;
    margin-right: -0.5rem;
}
.securepay-payment-form .px-2 {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}

.securepay-card-component {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 16px;
    min-height: 50px;
    background: white;
    transition: border-color 0.3s ease;
}

.securepay-card-component:focus-within {
    border-color: #0066cc;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
}

.apple-pay-button {
    -webkit-appearance: -apple-pay-button;
    -apple-pay-button-type: buy;
    -apple-pay-button-style: black;
    width: 100%;
    height: 44px;
    cursor: pointer;
    margin: 16px 0;
    border-radius: 4px;
}

.payment-processing {
    text-align: center;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 4px;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #0066cc;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.dcc-options {
    margin-top: 12px;
}

.dcc-option {
    display: block;
    margin-bottom: 8px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.dcc-option:hover {
    background-color: #f5f5f5;
}

.dcc-option input[type="radio"] {
    margin-right: 8px;
}

.dcc-option small {
    color: #666;
    font-size: 0.9em;
}

.securepay-error {
    margin-bottom: 16px;
    padding: 12px;
    border-radius: 4px;
    background-color: #fee;
    border: 1px solid #fcc;
    color: #900;
}

/* Security indicators */
.field .heading label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .securepay-payment-form .flex {
        flex-direction: column;
    }
    
    .securepay-payment-form .w-1\/2 {
        width: 100%;
    }
    
    .securepay-payment-form .-mx-2 {
        margin: 0;
    }
    
    .securepay-payment-form .px-2 {
        padding: 0;
        margin-bottom: 1rem;
    }
}
</style> 